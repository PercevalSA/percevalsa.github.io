<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><title>librespot on piCorePlayer - cyberstuff and halfworking projects</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=https://percevalsa.github.iofavicon.png><link rel=canonical href=https://percevalsa.github.io/posts/librespot-picore-player/><link rel=stylesheet href=/css/style.min.46f28338320bb2be67d9306169b35cbc1f6c81477c9089ac6b89bc6ff283ffb7.css><link rel=stylesheet href=/assets/css/extended.min.9729f28a5087b689b946e103d96abd63bfd37b1417effa251dbf798312e3fba5.css><meta name=description content="How to build librespot for piCorePlayer"><meta property="og:title" content="librespot on piCorePlayer"><meta property="og:type" content="website"><meta property="og:url" content="https://percevalsa.github.io/posts/librespot-picore-player/"><meta property="og:image" content="https://percevalsa.github.io/images/picore-logo.png"><meta property="og:description" content="How to build librespot for piCorePlayer"><meta name=twitter:card content="summary"><meta name=twitter:site content="PercevalSA"><meta name=twitter:creator content="PercevalSA"></head><body class='page frame page-blog-single'><div id=menu-main-mobile class=menu-main-mobile><ul class=menu><li class=menu-item-home><a href=https://percevalsa.github.io/>Home</a></li><li class=menu-item-blog><a href=https://percevalsa.github.io/posts/>Blog</a></li></ul></div><div id=wrapper class=wrapper><div class=header><a class=header-logo href=/>cyberstuff and halfworking projects</a><div class=menu-main><ul><li class=menu-item-home><a href=/><span>Home</span></a></li><li class="menu-item-blog active"><a href=/posts/><span>Blog</span></a></li></ul></div><div id=toggle-menu-main-mobile class=hamburger-trigger><button class=hamburger>Menu</button></div></div><div class=blog><div class=intro><h1>librespot on piCorePlayer<span class=dot>.</span></h1><img alt="Article hero image" src=/images/picore-logo.png></div><div class=content><h1 id=introduction>Introduction</h1><p>All the code is available in <a href=https://github.com/PercevalSA/pcp-librespot>my github repo</a></p><p>I wanted a stable headless Spotify player for my living room. It has to run on a RaspberryPi and boot fast in order to turn it on only when needed with a switch.
One of the solution would be Volumio or HifiBerry but they take too much time to boot. <a href=https://www.picoreplayer.org/>piCorePlayer</a> is a good alternative but it has too much stuff installed by default and the Spotify extension is based on an outdated extension. I would use something based on <a href=https://iotbyhvm.ooo/picore-tiny-core-linux-on-raspberry-pi/>piCore</a> which is the port of <a href=http://www.tinycorelinux.net/>Tiny Core Linux</a> to the RaspberryPi. piCorePlayer is based on piCore.
To stream spotify we will use <a href=https://github.com/librespot-org/librespot>librespot</a>. There is no librespote package for Tiny Core Linux and therefore for piCore. Therefore we need to build our own Spotify package. The purpose is to gain stability and performance compared to the piCorePlayer version.
For the OS we have two solutions:</p><ol><li>use piCorePlayer and remove everything that is not needed and install only my Spotify module;</li><li>start from a bare piCore image.</li></ol><p>I finally started from piCorePLayer because it configures my DAC out of the box. In the future I would migrate to a bare piCore version.</p><h2 id=requirements>Requirements</h2><p>To install something on TinyCore Linux we need to build a <code>tcz</code> extension. a <code>tcz</code>extension is then mounted at boot as <code>squashfs</code>. This allows to fast boot.</p><p>Sources:</p><ul><li><a href=https://github.com/librespot-org/librespot>librespot</a></li><li><a href=https://www.picoreplayer.org>PiCore Player</a></li></ul><h1 id=build>Build</h1><p>Librespot must be cross-compiled and placed in the <code>sbin</code> folder as <code>librespot</code>. Don&rsquo;t forget to <code>chmod +x librespot</code> before creating the <code>tcz</code> extension.</p><h3 id=cross-compilation>Cross Compilation</h3><p>Cross compilation of Librespot for RaspberryPi on Linux (raspbian, TinyCoreLinux, PiCore Linux&mldr;)
You must be on Debian 11 minimum for the cross compilation to work(because of libs version dependencies)</p><h3 id=install-cross-compilation-tools>Install cross-compilation tools</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo apt install git curl pkg-config build-essential gcc-arm-linux-gnueabihf lib32stdc++6 libstdc++6:armhf
</span></span></code></pre></div><h3 id=install-rust>Install RUST</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl --proto <span class=s1>&#39;=https&#39;</span> --tlsv1.2 -sSf https://sh.rustup.rs <span class=p>|</span> sh
</span></span><span class=line><span class=cl><span class=nb>source</span> <span class=nv>$HOME</span>/.cargo/env
</span></span></code></pre></div><h3 id=install-libraries>Install Libraries</h3><p>Create a folder where you will work.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> 
</span></span><span class=line><span class=cl>mkdir -p pcp-librespot/downloads/
</span></span><span class=line><span class=cl><span class=nb>cd</span> pcp-librespot/downloads
</span></span></code></pre></div><p>We need to download arm <code>gnueabihf</code> version of needed libraries. We search for armhf versions in the repos. Download only the lib you need for your backend:</p><ul><li>alsa and alsa dev for alsa backend</li><li>portaudio and portaudio dev for portaudio backend</li><li>libjack and libjack dev for jack backend (default in librespot)</li></ul><table><thead><tr><th>Lib</th><th>Source</th><th>Name of package</th></tr></thead><tbody><tr><td>portaudio19</td><td><a href=http://ftp.fr.debian.org/debian/pool/main/p/portaudio19/>http://ftp.fr.debian.org/debian/pool/main/p/portaudio19/</a></td><td>libportaudio2_19.6.0-1.1_armhf.deb</td></tr><tr><td>portaudio19 dev</td><td><a href=http://ftp.fr.debian.org/debian/pool/main/p/portaudio19/>http://ftp.fr.debian.org/debian/pool/main/p/portaudio19/</a></td><td>portaudio19-dev_19.6.0-1+deb10u1_armhf.deb or portaudio19-dev_19.6.0-1.1_armhf.deb</td></tr><tr><td>alsa</td><td><a href=http://ftp.fr.debian.org/debian/pool/main/a/alsa-lib/>http://ftp.fr.debian.org/debian/pool/main/a/alsa-lib/</a></td><td>libasound2_1.2.4-1.1_armhf.deb</td></tr><tr><td>alsa dev</td><td><a href=http://ftp.fr.debian.org/debian/pool/main/a/alsa-lib/>http://ftp.fr.debian.org/debian/pool/main/a/alsa-lib/</a></td><td>libasound2-dev_1.2.4-1.1_armhf.deb</td></tr><tr><td>libjack</td><td><a href=http://ftp.fr.debian.org/debian/pool/main/j/jackd2/>http://ftp.fr.debian.org/debian/pool/main/j/jackd2/</a></td><td>libjack-jackd2-0_1.9.17~dfsg-1_armhf.deb</td></tr><tr><td>libjack dev</td><td><a href=http://ftp.fr.debian.org/debian/pool/main/j/jackd2/>http://ftp.fr.debian.org/debian/pool/main/j/jackd2/</a></td><td>libjack-jackd2-dev_1.9.17~dfsg-1_armhf.deb</td></tr></tbody></table><p>We also need the armhf libc</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>wget ftp.fr.debian.org/debian/pool/main/g/gcc-10/libstdc++6_10.2.1-6_armhf.deb
</span></span></code></pre></div><h3 id=environment>environment</h3><p>If you still in <code>downloads</code> folder go back with <code>cd ..</code> else <code>cd pcp-librespot</code>
We need to configure the environement with a <code>sysroot</code> where we put all the libs needed for cross-compilation as librespot for arm can&rsquo;t use x86 libs.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir sysroot
</span></span></code></pre></div><p>Go where you&rsquo;ve download the libs and decompress packages in <code>pcp-librespot/sysroot</code> folder.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=k>for</span> a in <span class=k>$(</span>ls <span class=nv>$HOME</span>/pcp-librespot/downloads<span class=k>)</span><span class=p>;</span><span class=k>do</span> ar p <span class=nv>$a</span> data.tar.xz <span class=p>|</span> tar -xv -J -C <span class=nv>$HOME</span>/pcp-librespot/sysroot<span class=p>;</span><span class=k>done</span>
</span></span></code></pre></div><h3 id=build-1>build</h3><p>get the librespot sources</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>git clone https://github.com/librespot-org/librespot.git
</span></span></code></pre></div><p>Configure rust for cross-compilation</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;arm-linux-gnueabihf-gcc --sysroot </span><span class=nv>$HOME</span><span class=s2>/pcp-librespot/sysroot \&#34;\$@\&#34;&#34;</span> &gt;&gt; ./cargo/bin/gcc-sysroot
</span></span><span class=line><span class=cl>chmod +x .cargo/bin/gcc-sysroot 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> &lt;EOF&gt;&gt; <span class=nv>$HOME</span>/.cargo/config
</span></span><span class=line><span class=cl><span class=o>[</span>build<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=c1># Set default build target to armv7hf</span>
</span></span><span class=line><span class=cl><span class=nv>target</span> <span class=o>=</span> <span class=s2>&#34;armv7-unknown-linux-gnueabihf&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># Configure linker for your target</span>
</span></span><span class=line><span class=cl><span class=o>[</span>target.armv7-unknown-linux-gnueabihf<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>linker</span> <span class=o>=</span> <span class=s2>&#34;gcc-sysroot&#34;</span>
</span></span><span class=line><span class=cl>EOF
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>PKG_CONFIG_ALLOW_CROSS</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>PKG_CONFIG_SYSROOT_DIR</span><span class=o>=</span><span class=nv>$HOME</span>/pcp-librespot/sysroot/
</span></span><span class=line><span class=cl><span class=nb>export</span> PKG_CONFIG_DIR
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>PKG_CONFIG_PATH</span><span class=o>=</span><span class=nv>$HOME</span>/pcp-librespot/sysroot/usr/lib/arm-linux-gnueabihf/pkgconfig/
</span></span></code></pre></div><p>configure librespot build for cross-compilation</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> librespot
</span></span><span class=line><span class=cl>rustup target add armv7-unknown-linux-gnueabihf
</span></span><span class=line><span class=cl>rustup component add rustfmt
</span></span></code></pre></div><p>to build librespot with alsa-backend; this is what you want for raspbian and piCore Player</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cargo build --target<span class=o>=</span>armv7-unknown-linux-gnueabihf --no-default-features --features <span class=s2>&#34;alsa-backend&#34;</span>
</span></span></code></pre></div><p>if you need portaudio backend do this instead</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cargo build --target<span class=o>=</span>armv7-unknown-linux-gnueabihf --no-default-features --features <span class=s2>&#34;portaudio-backend&#34;</span>
</span></span></code></pre></div><p>you might need to specify <code>-L "/usr/lib/arm-linux-gnueabihf"</code> for building.</p><p>Create a folder to build the package and copy the binary into the package folder</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> <span class=nv>$HOME</span>/pcp-librespot
</span></span><span class=line><span class=cl>mkdir -p package/usr/local/sbin/
</span></span><span class=line><span class=cl>cp target/armv7-unknown-linux-gnueabihf/release/librespot package/usr/local/sbin/
</span></span><span class=line><span class=cl>chmod +x package/usr/local/sbin/librespot
</span></span></code></pre></div><p>Now we can buid a Tiny Core package: an extension.</p><h2 id=create-extension-to-be-installed>create extension to be installed</h2><p>create the extension</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mksquashfs package pcp-librespot.tcz
</span></span></code></pre></div><h1 id=installation>Installation</h1><h3 id=install-librespot-extension-on-pcp>Install librespot extension on pcp</h3><p>send it on your RaspberryPi running piCorePlayer:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>scp pcp-librespot.tcz tc@pcp.local:
</span></span><span class=line><span class=cl>ssh tc@pcp.local
</span></span><span class=line><span class=cl>mv -v pcp-librespot.tcz /etc/sysconfig/tcedir/optional
</span></span></code></pre></div><p>activate start up on boot</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>echo</span> pcp-librespot.tcz &gt;&gt; /etc/sysconfig/tcedir/onboot.lst
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;/usr/local/etc/init.d/librespot start&#34;</span> &gt;&gt; /opt/bootlocal.sh 
</span></span><span class=line><span class=cl>pcp bu
</span></span></code></pre></div><p>reboot or launch the extention with</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tce-load -i pcp-librespot
</span></span></code></pre></div><p>And that&rsquo;s it. A fast booting Linux running Librespot to stream Spotify on your speaker.</p></div></div><div class=footer><div class=footer-social><span class="social-icon social-icon-twitter"><a href=https://twitter.com/percevalsa title=twitter target=_blank rel=noopener><img src=/images/social/twitter.svg width=24 height=24 alt=twitter></a></span>
<span class="social-icon social-icon-github"><a href=https://github.com/percevalsa title=github target=_blank rel=noopener><img src=/images/social/github.svg width=24 height=24 alt=github></a></span>
<span class="social-icon social-icon-linkedin"><a href=https://www.linkedin.com/in/perceval-arenou/ title=linkedin target=_blank rel=noopener><img src=/images/social/linkedin.svg width=24 height=24 alt=linkedin></a></span></div></div></div><script type=text/javascript src=/js/bundle.min.5993fcb11c07dea925a3fbd58c03c7f1857197c35fccce3aa963a12c0b3c9960.js></script></body></html>